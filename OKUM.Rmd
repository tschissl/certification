Analyzing submitted data for OKUM
========================================================

```{r}
measurand <- 'SiO2'
```

## measurand selected `r measurand`


#### Importing the data and assigning factors

```{r results='hide'}
library(ggplot2)
# library(devtools) #needed for "order_by"
# install_github("plotflow", "trinker")
library(plotflow) #needed for "order_by" # install_github("plotflow", "trinker")
library(metRology) #for mandel k and h calculations

GAS <- read.csv("~/GitHub/certification/GAS.csv", sep=";")
OKUM <- read.csv("~/GitHub/certification/OKUM.csv", sep=";")
MUH <- read.csv("~/GitHub/certification/MUH.csv", sep=";")
OKUM.methods <- read.csv("~/GitHub/certification/OKUM methods.csv", sep=";")
GOM <- data.frame(OKUM, MUH[6:60], GAS[6:60])
GOM <- merge(GOM, OKUM.methods) # merging all data and all methods
#defining factors 
GOM$Lab <- as.factor(GOM$Lab)
GOM$Packet <- as.factor(GOM$Packet)
GOM$Prep <- as.factor(GOM$Prep)
GOM$day <- as.factor(GOM$day)
GOM$names <- as.factor(GOM$names)
GOMorig <- GOM  #keeping the original file
```

#### defining the plotting theme

```{r}
mytheme <- theme_grey() + theme(plot.title = element_text(colour = "black", size = rel(2))) + theme(axis.title.x = element_text(size = rel(1.8)))+ theme(axis.title.y = element_text(size = rel(1.8))) +theme(axis.text.x = element_text(size = rel(1.5))) + theme(axis.text.y = element_text(size = rel(1.5))) + theme(legend.title = element_text(size = rel(1))) +theme(legend.text = element_text(size = rel(0.8)))
```
#### initial calculations with complete data set

```{r creating means}
## means over packets within lab 
require(plyr)
meanGOM <- function(x) mean(x, na.rm=TRUE)
meanGOM.packet <- ddply(GOM, c("Lab", "Packet"), numcolwise(meanGOM))
## median over median of packets within lab
GOM.mean <- ddply(meanGOM.packet, c("Lab"), numcolwise(meanGOM))
```
```{r creating median}
## median over packets within lab 
require(plyr)
medianGOM <- function(x) median(x, na.rm=TRUE)
medianGOM.packet <- ddply(GOM, c("Lab", "Packet"), numcolwise(medianGOM))
## median over median of packets within lab
GOM.median <- ddply(medianGOM.packet, c("Lab"), numcolwise(medianGOM))
```
#### defining the function for plotting methods vs. measurand mass fraction. Sample preparation methods are also marked in the plot.
```{r plot_method function plotting measurand vs. method}
### function plot_method defined here. Automated plot of methods boxplots sorted by increasing method mean. Enter with plot_method=('xx') #######
plot_method <- function(x) {
  element <- x
  '%p%' <- function(x, y) {as.character(paste (x, y, sep =""))}
  prep <-  'Prep.'
  method <- 'Method.'
  anal.prep <- prep %p% element
  anal.method <- method %p% element
  anal <- GOM[[element]]
  anal.prep <- GOM[[anal.prep]]
  anal.method <- GOM[[anal.method]]
  analyte <- data.frame(GOM$Lab, GOM$names, anal, anal.prep, anal.method )
  analyte <- na.omit(analyte)
  p <- ggplot(reorder_by(anal.method, ~anal, analyte, mean), aes(anal.method, anal)) + geom_boxplot(outlier.shape = NA) + geom_jitter(aes(colour=anal.prep), size = 4.5, position = position_jitter(width = .2))
  p + xlab("method") + ylab("mg/kg or g/100g") + labs(title = element) + labs(colour = "Prep") + mytheme
}
```
```{r plot_lab function plot measurand vs. lab}
###### function plot_lab #### 
# defined here. Automated plot of lab boxplots sorted by increasing lab mean and Horwitz function. Enter with plot_lab=('xx')
plot_lab <- function(x, type) {
  element <- x
  '%p%' <- function(x, y) {as.character(paste (x, y, sep =""))}
  prep <-  'Prep.'
  method <- 'Method.'
  anal.prep <- prep %p% element
  anal.method <- method %p% element
  anal <- GOM[[element]]
  anal.prep <- GOM[[anal.prep]]
  anal.method <- GOM[[anal.method]]
  analyte <- data.frame(GOM$Lab, GOM$names, anal, anal.prep, anal.method )
  analyte <- na.omit(analyte)
  avg <- median(tapply(analyte$anal, analyte$GOM.Lab, mean, na.rm=TRUE), na.rm=TRUE)
  switch(type, 
         M = hor <- 1*(0.01*avg)^0.8495, 
         T = hor <- 10000*1*(0.01*avg/10000)^0.8495)
  # hor <- 1*(0.01*avg)^0.8495
  u.hor <- avg + hor
  u.2hor <- avg + 2*hor
  l.hor <- avg - hor
  l.2hor <- avg - 2*hor
  p <- ggplot(reorder_by(GOM.Lab, ~anal, analyte, mean), aes(GOM.Lab, anal)) + geom_abline(intercept = avg, slope = 0) + geom_abline(intercept = u.2hor, slope = 0, linetype ="dotted") + geom_abline(intercept = l.2hor, slope = 0, linetype = "dotted") + geom_abline(intercept = u.hor, slope = 0, linetype ="dashed") + geom_abline(intercept = l.hor, slope = 0, linetype = "dashed")
  p <- p + geom_boxplot(aes(fill=anal.method)) + geom_point(size=4) + geom_point(aes(colour=anal.prep), size = 3.5) 
  p + xlab("lab") + ylab("mg/kg or g/100g") + labs(title = element) + labs(colour = "Prep") + geom_smooth(aes(group=1)) + mytheme
}
```
```{r plot_youd functin for youden plot}
plot_youd <- function(a, y, z) { # a = measurand, y and z ref
  '%p%' <- function(a, b) {as.character(paste (a, b, sep =""))}
  switch(
    y,
    GAS = rm1 <- 2,
    MUH = rm1 <- 1,
    OKUM = rm1 <- 0
  )
  switch(
    z,
    GAS = rm2 <- 2,
    MUH = rm2 <- 1,
    OKUM = rm2 <- 0
  )
  if(rm1 > 0) 
  {RM1 <- a %p% '.' %p% rm1
  } else 
  {
    RM1 <- a
  }
  if(rm2 > 0) 
  {RM2 <- a %p% '.' %p% rm2
  } else 
  {
    RM2 <- a
  }
  
  RM1 <- GOM[[RM1]]
  RM1 <- (RM1-median(RM1, na.rm = TRUE))/sd(RM1, na.rm = TRUE) #calculating z-scores
  RM2 <- GOM[[RM2]]
  RM2 <- (RM2-median(RM2, na.rm = TRUE))/sd(RM2, na.rm = TRUE) #calculating z-scores
  RM <- data.frame(GOM$Lab, GOM$names, RM1, RM2)
  RM <- na.omit(RM)
  p <- ggplot(RM, aes(RM1, RM2, label = GOM.Lab))  + xlim(-5, 5) + ylim(-5,5) + geom_point(aes(colour=factor(GOM.Lab)), size = 4)
  p <- p + xlab(y) + ylab(z) + labs(title = a) + labs(colour = "Lab") + mytheme + geom_abline(intercept = 0, slope = 1) +  geom_abline(intercept = 2.8284, slope = 1) +  geom_abline(intercept = - 2.8284, slope = 1) +  geom_abline(intercept = 2.8284, slope = - 1) +  geom_abline(intercept = -2.8284, slope = - 1) + geom_text(data = NULL, x = -0.5, y = 2.85, label = "z = 2") + geom_text(aes(colour=factor(GOM.Lab)), hjust=1, vjust=0)
  p + theme(legend.position="none") #+ stat_density2d(aes(fill = ..level..), geom="polygon") 
}

```
```{r function calculating mean and median for individual measurand}
avgbymethod <- function(x) {
  element <- x
  '%p%' <- function(x, y) {as.character(paste (x, y, sep =""))}
  prep <-  'Prep.'
  method <- 'Method.'
  anal.prep <- prep %p% element
  anal.method <- method %p% element
  anal <- GOM[[element]]
  anal.prep <- GOM[[anal.prep]]
  anal.method <- GOM[[anal.method]]
  analyte <- data.frame(GOM$Lab, GOM$names, anal, anal.prep, anal.method )
  analyte <- na.omit(analyte)
  bymethod <- tapply(analyte$anal, analyte$anal.method, mean, na.rm=TRUE)
  cat("method means", "\n")
  print(bymethod)
  avg <- mean(tapply(analyte$anal, analyte$GOM.Lab, mean, na.rm=TRUE), na.rm=TRUE)
  median <- median(tapply(analyte$anal, analyte$GOM.Lab, median, na.rm=TRUE), na.rm=TRUE)
  # cat("mean of lab means: ","\n")
  # cat(round(avg,3),"g/100g", "\n")
  # cat("median of lab medians: ","\n")
  # cat(round(median,3),"g/100g", "\n")
}
```
```{r summary as is for indiviual measurand}
summary(GOM[[measurand]], na.rm=TRUE, digits=4)
mean.before <- mean(GOM.mean[[measurand]], na.rm=TRUE)
median.before <- median(GOM.median[[measurand]], na.rm=TRUE)
```
The `r measurand` mean of the Lab means is `r round(mean.before, 4)` g/100 g  
The `r measurand` median of the Lab+Package medians is `r round(median.before, 4)` g/100 g  

```{r method averages as is}
avgbymethod(measurand)
```

```{r methods and lab plot as is, fig.width=10, fig.height=4}
plot_method(measurand); plot_lab(measurand,'M')
```
```{r fig.width=6, fig.height=6}
plot_youd(measurand, 'GAS', 'OKUM'); plot_youd(measurand, 'MUH', 'OKUM')
```
#### Mandel k barplot displays the within lab performance relative to all participating labs using the median over packages
```{r mandel k, fig.width=10, fig.height=6}
k <- with(medianGOM.packet, mandel.kh(medianGOM.packet[[measurand]], g=Lab, type="k"))     
barplot(k, las=2, col=1:4)
```

#### Removing ouliers lab based on Youden plot

```{r outlier removal, fig.width=10, fig.height=6}
outlier <- c(16) ## defining the outlying lab here with lab#
leng <- length(outlier) ## counting the number of outliers for loop
for(i in 1:leng) ##  looping
{
  GOM[[measurand]] <- ifelse(GOM$Lab==outlier[i], NA, GOM[[measurand]]) ## replacing values of outlying lab with "NA" and defining new GOM
  message("Lab ", outlier[i], " was removed")
  print(summary(GOM[[measurand]], na.rm=TRUE, digits=4))
  }
plot_lab(measurand, 'M') # replotting without outlier
```
```{r}
avgbymethod(measurand)
```
```{r}
summary(GOM[[measurand]], na.rm=TRUE, digits=4)
mean <- mean(tapply(GOM[[measurand]], GOM$Lab, mean, na.rm=TRUE), na.rm=TRUE)
median.before <- median(GOM.median[[measurand]], na.rm=TRUE)
medianGOM.packet.after <- ddply(GOM, c("Lab", "Packet"), numcolwise(medianGOM))
## median over median of packets within lab
GOM.median.after <- ddply(medianGOM.packet.after, c("Lab"), numcolwise(medianGOM))
median.after <- median(GOM.median.after[[measurand]], na.rm=TRUE)
```
The `r measurand` median of the Lab+packet medians without outlier removal is `r round(median.before, 4)` g/100 g  
The `r measurand` mean of the Lab means after outlier removal of lab # `r outlier` is `r round(mean, 4)` g/100 g  
The `r measurand` median of the Lab+packet medians after outlier removal is `r round(median.after, 4)` g/100 g  